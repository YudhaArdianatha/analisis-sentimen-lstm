<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Analisis Sentimen LSTM</title>
  </head>
  <body>
    <div class="px-4 py-5 my-5 text-center mt-0 bg-image">
      <h1 class="display-5 fw-bold mt-5">Analisis Sentimen</h1>
      <div class="col-lg-6 mx-auto">
        <p class="lead mb-4">
          Analisis sentimen adalah proses memahami dan mengelompokkan emosi dalam teks untuk mengungkap opini positif, negatif, atau netral, sehingga membantu bisnis dan peneliti memahami pandangan pengguna secara mendalam.
        </p>
        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
          <button type="button" class="btn btn-dark btn-lg px-4 gap-3">Mulai Analisis</button>
        </div>
      </div>
    </div>
    <section class="input">
      <div class="container">
        <div class="row">
          <div class="row justify-content-center text-center">
            <div class="col">
              <h1>Input Sentimen</h1>
            </div>
          </div>
          <div class="row justify-content-center text-center mt-1">
            <div class="col-md-6">
              <h5 class="secondary-text">Input dapat berupa ulasan / file excel / kode dari aplikasi</h5>
            </div>
          </div>
          {% if error_message %}
          <div class="row justify-content-center text-center mt-3">
            <div class="col-md-6">
              <div class="alert alert-danger">{{ error_message }}</div>
            </div>
          </div>
          {% endif %}
          <div class="row justify-content-center align-items-center text-center m-3">
            <div class="col-md-2">
              <button class="btn btn-outline-primary" id="btnSentiment">Ulasan</button>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-primary" id="btnFile">File Excel</button>
            </div>
            <div class="col-md-2 me-5">
              <button class="btn btn-outline-primary" id="btnKode">Kode Aplikasi</button>
            </div>
          </div>
          <div class="row justify-content-center">
            <div class="col-md-6">
              <form id="textForm" action="/analyze_text" method="POST">
                <div class="input-group mb-3" id="inputSentiment">
                  <input type="text" class="form-control" name="text" placeholder="Masukan suatu ulasan" required autocomplete="off" />
                  <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Submit</button>
                  <div id="textError" class="text-danger mb-3" style="display: none">Harap masukkan ulasan terlebih dahulu.</div>
                </div>
              </form>
              <form id="fileForm" action="/analyze_csv" method="POST" enctype="multipart/form-data">
                <div class="input-group text-center justify-content-center" id="inputFile">
                  <div class="input-group">
                    <input type="file" class="form-control" name="file" accept=".xlsx, .xls" placeholder="Masukan File .csv" required />
                    <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Upload</button>
                  </div>
                  <div id="fileError" class="text-danger mb-3" style="display: none">Harap unggah file terlebih dahulu.</div>

                  <h5 class="secondary-text mt-3">Semakin banyak data, semakin lama prosesnya.</h5>
                  <h5 class="secondary-text">Kolom ulasan harus bernama 'content' (tanpa tanda petik).</h5>
                </div>
              </form>
              <form id="appForm" action="/analyze_appcode" method="POST" enctype="multipart/form-data">
                <div class="input-group" id="inputKode">
                  <input type="text" class="form-control" name="app_code" placeholder="Masukan kode aplikasi" required autocomplete="off" />
                  <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Submit</button>
                  <div id="appCodeError" class="text-danger mt-2" style="display: none">Harap masukkan kode aplikasi terlebih dahulu.</div>
                </div>
              </form>
            </div>
          </div>
        </div>

        {% if sentiment or percentages %}
        <div class="row mt-5 p-3">
          <div class="col-md-12 text-center">
            <h2>Hasil Analisis Sentimen</h2>
          </div>

          {% if sentiment %}
          <div class="text-center mt-3">
            <h4>Ulasan: {{ text }}</h4>
            <h4>Prediksi sentimen: {{ sentiment }}</h4>
            <h5>Confidence Score: {{ confidence_score | round(4) }}</h5>
          </div>
          {% endif %} {% if percentages %}
          <div class="row justify-content-center align-items-center">
            <div class="col-md-6">
              <canvas id="sentimentChart" class="chart-canvas"></canvas>
            </div>
            <div class="col-md-6">
              <img src="/{{ wordcloud_path }}" alt="Word Cloud" class="wc-img" />
            </div>
          </div>

          {% if average_confidence %}
          <div class="text-center mt-3">
            <h5>Rata-rata Confidence Score: {{ average_confidence }}</h5>
          </div>
          {% endif %}
          <script>
            var ctx = document.getElementById("sentimentChart").getContext("2d");
            var sentimentData = {{ [percentages['positif'], percentages['negatif'], percentages['netral']] | tojson }};
            var sentimentChart = new Chart(ctx, {
              type: 'pie',
              data: {
                labels: ['Positif', 'Negatif', 'Netral'],
                datasets: [{
                  label: 'Persentase Sentimen',
                  data: sentimentData,
                  backgroundColor: ['#4CAF50', '#F44336', '#FFC107']
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false
              }
            });
          </script>
          <div class="row mt-4">
            <div class="col-md-11">
              <h4>Kesimpulan</h4>
            </div>
            <div class="col-md-1">
              <a href="/download/{{ download_link }}"><button class="btn btn-primary">Download</button></a>
            </div>
          </div>
          <div class="mt-3">
            <h5>
              Dari total {{ jumlah_data }} ulasan yang diambil, {{ percentages['positif'] }}% positif, {{ percentages['negatif'] }}% negatif, dan {{ percentages['netral'] }}% netral. Gunakan data ini sebaik mungkin untuk memahami persepsi
              pengguna dan meningkatkan kualitas layanan secara menyeluruh. Temuan ini dapat membantu dalam mengidentifikasi keunggulan serta area yang masih perlu diperbaiki. Dengan analisis yang tepat, data ini dapat menjadi dasar
              pengambilan keputusan yang lebih terarah dan berkelanjutan.
            </h5>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <div class="row mt-3 p-3">
          <div class="row mt-3">
            <div class="col-md-8">
              <h2>Tahapan Mencari Kode Aplikasi</h2>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md">
              <img class="img-fluid" src="/static/images/find-code.png" alt="find_code" width="1500" />
            </div>
          </div>
        </div>
      </div>
    </section>
    <footer class="bg-primary text-white py-4 mt-5">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6 text-center text-md-start mb-2 mb-md-0">
            <p class="mb-0">&copy; 2025 <strong>Sentiment Analyzer</strong></p>
          </div>
          <div class="col-md-6 text-center text-md-end">
            <small>by: <strong>Sang Made Yudha Ardianatha</strong> | ðŸ“ž 0813-3866-5572</small>
          </div>
        </div>
      </div>
    </footer>
    <div id="loadingOverlay" style="display: none">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
  <script>
    const btnSentiment = document.getElementById("btnSentiment");
    const btnFile = document.getElementById("btnFile");
    const btnKode = document.getElementById("btnKode");

    const inputSentiment = document.getElementById("inputSentiment");
    const inputFile = document.getElementById("inputFile");
    const inputKode = document.getElementById("inputKode");

    const buttons = [btnSentiment, btnFile, btnKode];

    btnSentiment.addEventListener("click", function () {
      showInput("sentiment");
      localStorage.setItem("lastInput", "sentiment");
    });

    btnFile.addEventListener("click", function () {
      showInput("file");
      localStorage.setItem("lastInput", "file");
    });

    btnKode.addEventListener("click", function () {
      showInput("kode");
      localStorage.setItem("lastInput", "kode");
    });

    function showInput(type) {
      // Reset semua input dan tombol
      inputSentiment.classList.add("d-none");
      inputFile.classList.add("d-none");
      inputKode.classList.add("d-none");

      buttons.forEach((btn) => btn.classList.remove("active"));

      // Tampilkan sesuai tipe yang dipilih
      if (type === "sentiment") {
        inputSentiment.classList.remove("d-none");
        btnSentiment.classList.add("active");
      } else if (type === "file") {
        inputFile.classList.remove("d-none");
        btnFile.classList.add("active");
      } else if (type === "kode") {
        inputKode.classList.remove("d-none");
        btnKode.classList.add("active");
      }
    }

    // Ambil pilihan terakhir dari localStorage saat halaman dimuat
    const lastInput = localStorage.getItem("lastInput") || "sentiment";
    showInput(lastInput);

    // Validasi form sebelum submit
    document.getElementById("textForm").addEventListener("submit", function (e) {
      const input = this.querySelector('input[name="text"]');
      if (!input.value.trim()) {
        e.preventDefault();
        input.classList.add("is-invalid");
      }
    });

    document.getElementById("fileForm").addEventListener("submit", function (e) {
      const input = this.querySelector('input[name="file"]');
      if (!input.files || input.files.length === 0) {
        e.preventDefault();
        input.classList.add("is-invalid");
      }
    });

    document.getElementById("appForm").addEventListener("submit", function (e) {
      const input = this.querySelector('input[name="app_code"]');
      if (!input.value.trim()) {
        e.preventDefault();
        input.classList.add("is-invalid");
      }
    });

    // Reset validasi saat input diubah
    document.querySelectorAll("input").forEach((input) => {
      input.addEventListener("input", function () {
        this.classList.remove("is-invalid");
      });
    });

    const showLoading = () => {
      document.getElementById("loadingOverlay").style.display = "flex";
    };

    document.getElementById("textForm").addEventListener("submit", function (e) {
      const input = this.querySelector('input[name="text"]');
      if (!input.value.trim()) {
        e.preventDefault();
        input.classList.add("is-invalid");
      } else {
        showLoading();
      }
    });

    document.getElementById("fileForm").addEventListener("submit", function (e) {
      const input = this.querySelector('input[name="file"]');
      if (!input.files || input.files.length === 0) {
        e.preventDefault();
        input.classList.add("is-invalid");
      } else {
        showLoading();
      }
    });

    document.getElementById("appForm").addEventListener("submit", function (e) {
      const input = this.querySelector('input[name="app_code"]');
      if (!input.value.trim()) {
        e.preventDefault();
        input.classList.add("is-invalid");
      } else {
        showLoading();
      }
    });
  </script>
</html>
<style>
  * {
    font-family: poppins, sans-serif;
  }
  .bg-image {
    position: relative;
    background-image: url("/static/images/bg-index.jpg");
    background-size: cover;
    background-position: center;
    z-index: 1;
    color: white;
    height: 80vh;
  }

  .bg-image::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: -1;
  }

  .secondary-text {
    color: #6d6d6d;
    font-size: 1rem;
  }

  .wc-img {
    width: 100%;
    max-width: 400px;
    height: auto;
    display: block;
    margin: 0 auto;
  }

  a {
    text-decoration: none;
  }

  .chart-canvas {
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  #sentimentChart {
    max-width: 300px;
    max-height: 300px;
  }

  #loadingOverlay {
    position: fixed;
    z-index: 9999;
    background-color: rgba(255, 255, 255, 0.8);
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
